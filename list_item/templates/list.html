{% extends 'master.html' %}

{% block title %}
    <title>Список</title>
{% endblock %}

{% block body %}
    <section class="wrapper__relationship">
        <div class="relationship__table-data">
            <div class="table-data__table-header">
                <div class="table-data_table-header-item-1">
                    <a href='{% url "main:main" %}'>
                        {{ list_name.name }}
                    </a>
                </div>
                <a class="table-data_table-header-item-2" href="{% url "list_item:all_done" %}">
                    <div class="header__button-create-bundle">all</div>
                </a>
                <a class="add_new_list" href="{% url "list_item:create" pk=list_name.id %}">
                    <div class="header__button-create-bundle">+</div>
                </a>
            </div>
            {% for list in lists %}
                <div id="list_{{ list.id }}" class="table-data__table-row">
                    {% if list.is_done %}
                        <div id="isDone_{{ list.id }}"
                             class="table-row_table_cell-1 is_done_text"> {{ list.name }}</div>
                    {% else %}
                        <div id="isDone_{{ list.id }}" class="table-row_table_cell-1"> {{ list.name }}</div>
                    {% endif %}
                    <div class="buttons">
                        <div class="table-data-two_table-icon">
                            <a href='{% url "list_item:edit" pk=list.id %}'>
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                          d="M20 18V11H18V18H2V2H9V0H2C0.89543 0 0 0.89543 0 2V18C0 19.1046 0.89543 20 2 20H18C19.1046 20 20 19.1046 20 18ZM17.1781 0.723423C16.7197 0.26142 16.0921 0 15.4374 0C14.7834 0 14.1564 0.26083 13.6954 0.724628L5.3265 9.09342C4.57867 9.75233 4.08844 10.7328 4.00325 11.7873L4 15.0023V16.0023H8.1346C9.2689 15.9245 10.259 15.4295 10.9575 14.6238L19.279 6.30584C19.7407 5.84416 20.0001 5.21799 20.0001 4.56508C20.0001 3.91217 19.7407 3.286 19.279 2.82432L17.1781 0.723423ZM8.06398 14.0048C8.59821 13.967 9.09549 13.7184 9.49479 13.2616L15.5567 7.19972L12.8024 4.44527L6.6961 10.5496C6.29095 10.9079 6.04031 11.4092 6 11.8678V14.0029L8.06398 14.0048ZM14.2169 3.03128L16.9709 5.78551L17.8648 4.89162C17.9514 4.80502 18.0001 4.68756 18.0001 4.56508C18.0001 4.4426 17.9514 4.32514 17.8648 4.23854L15.7611 2.13486C15.6755 2.04855 15.5589 2 15.4374 2C15.3158 2 15.1992 2.04855 15.1136 2.13486L14.2169 3.03128Z"
                                          fill="#FF4646"/>
                                </svg>
                            </a>
                        </div>
                        <div class="calendarik">
                            {% if list.expare_date %}
                                {{ list.expare_date }}
                            {% else %}
                                <img src="/static/images/calendar.png" alt="calendar" width="26px" height="24px">
                            {% endif %}
                        </div>
                        <div class="table-row_table_icon">
                            <a class="delete_button" href="{% url "list_item:delete" pk=list.id %}">
                                <svg width="20" height="22" viewBox="0 0 20 22" fill="none"
                                     xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                          d="M6.99987 0H12.9999C14.1044 0 14.9999 0.89543 14.9999 2V3H18C19.1046 3 20 3.89543 20 5V7C20 8.10457 19.1046 9 18 9H17.9196L16.9997 20C16.9997 21.1046 16.1043 22 14.9997 22H4.99974C3.89517 22 2.99974 21.1046 3.00319 20.0831L2.07961 9H2C0.895431 9 0 8.10457 0 7V5C0 3.89543 0.895431 3 2 3H4.99987V2C4.99987 0.89543 5.8953 0 6.99987 0ZM4.99987 5V4.99999H1.99987V6.99999H17.9999V4.99999H14.9999V5H4.99987ZM4.99954 20L4.08603 9H15.9127L15.003 19.917L14.9995 20H4.99954ZM13.0001 1.99999V2.99999H7.00013V1.99999H13.0001Z"
                                          fill="#BBC1C7"/>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>

    </div>
    {% if pages.1 %}
        <div class="table-data__table-row">
            <div class="paginator_class">
                <ul class="pagination-wrapper_button">
                    {% for page in pages %}
                        <li><a class="active" href="/list/{{ list_name.id }}?page={{ page }}">{{ page }}</a></li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block js %}
    <script>
        const body = document.getElementsByClassName('relationship__table-data')[0];
        const listId = JSON.parse('{{ list_name.id|safe }}');
        const rows = document.querySelectorAll('.table-row_table_cell-1');
        const delButtons = document.querySelectorAll('.delete_button');
        console.log(delButtons);
        const token = getCookie('csrftoken');
        const deleteAllButton = document.getElementsByClassName('table-data_table-header-item-2')[0];

        rows.forEach(handler);
        delButtons.forEach(button => {
            button.addEventListener('click', delFunction);
        });
        deleteAllButton.addEventListener('click', allDone);
        console.log(rows);

        function allDone(event) {
            event.preventDefault();
            const url = event.currentTarget.href;
            return fetch(url, {
                method: 'POST',
                headers: new Headers({'X-CSRFToken': token}),
                redirect: 'follow',
                body: JSON.stringify({listId: listId})
            }).then(response => {
                if (response.status === 201) {
                    rows.forEach(row => {
                        row.classList.add('is_done_text');
                    });
                } else {
                    alert('Сервер не доступен');
                }
            });
        }

        function handler(row) {
            row.addEventListener('click', isDoneRequest);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(
                            cookie.substring(name.length + 1)
                        );
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function isDoneRequest(event) {
            const id = event.target.id.split('_').pop();
            const url = document.location.href.replace(`/${listId}`, '/done/');
            return fetch(url, {
                method: 'POST',
                headers: new Headers({'X-CSRFToken': token}),
                redirect: 'follow',
                body: JSON.stringify({id: id})
            }).then(response => {
                if (response.status === 201) {
                    if (event.target.classList.contains('is_done_text')) {
                        event.target.classList.remove('is_done_text');
                    } else {
                        event.target.classList.add('is_done_text');
                    }
                } else {
                    alert('Сервер не доступен');
                }
            })
        }

        function createMessageBlock(title, text) {
            const divBlock = document.createElement('div');
            divBlock.className = 'wrapper__auth';
            divBlock.id = "id_new_edit_block";
            divBlock.innerHTML = `<div class="auth__column_right"><div class="auth__column_right_form"><div class="auth__column_right_form__header">${title}</div><div id="message_text"> ${text}</div><div class="auth__column_right__form_footer"><label class="form_footer_button-submit"><input type="submit" form="auth_form" value="" style="display: none"><a href="#" id="login-submit-btn"><div class="auth__button_submit"  ><span>&#10004</span></div></a></label><label class="form_footer_button-cancel"><a href="#" id="cancel_btn"><div class="auth__button_submit" id="login-cancel-btn" ><span>&#9587</span></div></a></label></div></div></div>`;
            return divBlock;
        }

        function deleteMessageBlock(event) {
            event.preventDefault();
            document.getElementById('id_new_edit_block').remove();
        }

        function deleteListItem(url, event) {
            const pk = url.split('/').pop();
            const rowId = `list_${pk}`;
            deleteMessageBlock(event);
            return fetch(url, {
                method: 'POST',
                headers: new Headers({'X-CSRFToken': token}),
                redirect: 'follow',
            }).then(response => {
                if (response.status === 201) {
                    document.getElementById(rowId).remove()
                } else {
                    alert('Удалить не получилось');
                }
            })
        }

        function delFunction(event) {
            event.preventDefault();
            const url = event.currentTarget.href;
            const message = createMessageBlock('Внимание', 'Вы действительно хотите удалить дело?');
            body.appendChild(message);
            document.getElementById('cancel_btn').addEventListener(
                'click', event => deleteMessageBlock(event)
            );
            document.getElementById('login-submit-btn').addEventListener(
                'click', event => deleteListItem(url, event)
            );
        }

    </script>
{% endblock %}
